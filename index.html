<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="UTF-8">
    <title>Mplatform by ParkMinKyu</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--<link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">-->
    <!--<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>-->
    <!--<link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">-->
</head>
<body>
<div id="map" style="width:100%;height:300px;"></div>
<button id="getParkList">지역정보불러오기</button>
<a href="#" id="kakaoBtn">
	<img src="https://github.com/ParkMinKyu/newLotto/blob/gh-pages/kakaolink_btn_small.png?raw=true"/>
</a>
<div id="areaList">

</div>
<div id="parkList">

</div>
<div id="parkProgramList">

</div>
<div id="weather">
	<div id="T1H">기온 : <span></span></div>
	<div id="RN1">1시간 강수량 : <span></span></div>
	<div id="SKY">하늘상태 : <span></span></div>
	<div id="UUU">동서바람성분 : <span></span></div>
	<div id="VVV">남북바람성분 : <span></span></div>
	<div id="REH">습도 : <span></span></div>
	<div id="PTY">강수형태 : <span></span></div>
	<div id="LGT">낙뢰 : <span></span></div>
	<div id="VEC">풍향 : <span></span></div>
	<div id="WSD">풍속 : <span></span></div>    
</div>
<script src="/mplatform/js/jquery-1.11.3.min.js" type="text/javascript"></script>
<script type="text/javascript" src="//apis.daum.net/maps/maps3.js?apikey=5f101424c141ce53e3ed5e26f10ca225"></script>
<script>
	var mapContainer = document.getElementById('map'), // 지도를 표시할 div
	    mapOption = {
	        center: new daum.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
	        level: 5 // 지도의 확대 레벨
	    };

	// 지도를 표시할 div와  지도 옵션으로  지도를 생성합니다
	var map = new daum.maps.Map(mapContainer, mapOption);
	map.addOverlayMapTypeId(daum.maps.MapTypeId.TRAFFIC);

	var parkList = {};

	$(function(){
		$('#getParkList').click(function(){
		    if(parkList.totalCount == null)
			    JavascriptBridge.getParkList();
			else
			    displayArea();
		});

		$('#kakaoBtn').click(function(){
			JavascriptBridge.sendMessage("test");
		});
	});

    function compare(a,b) {
      var pat = /(서울특별시) ([가-힣]+)/g;
      var pat2 = /(서울특별시) ([가-힣]+)/g;
      var addr1;
      var addr2;
      if(pat.test(a.P_ADDR)){
            addr1 = RegExp.$2;
      }
      if(pat2.test(b.P_ADDR)){
            addr2 = RegExp.$2;
      }
      if (addr1 < addr2)
        return -1;
      if (addr1 > addr2)
        return 1;
      return 0;
    }

    function setParkList(data){
		parkList.totalCount = data["SearchParkInfoService"]["list_total_count"];
        parkList.row = data["SearchParkInfoService"]["row"];
        parkList.row.sort(compare);
        displayArea();
    }

    function displayArea(){
		$('#areaList').html('');
        for(var i = 0 ; i < parkList.row.length ; i ++){
            var park = parkList.row[i];
            var pat = /(서울특별시) ([가-힣]+)/g;
            if(pat.test(park.P_ADDR)){
                var areaName = RegExp.$2;
                if( $('#'+areaName).length > 0 ){
                    var count = parseInt($('#' + areaName + ' #count').text())+1;
                    $('#' + areaName + ' #count').text(count);
                }
                else{
                    $('#areaList').append('<div onclick="displayParkList(\''+areaName+'\');" id="'+areaName+'">'+areaName+' ( <span id="count">'+1+'</span>개 )</div>');
                 }
            }
        }
    }

    function displayParkList(areaName){
		$('#parkList').html('');
        for(var i = 0 ; i < parkList.row.length ; i ++){
            var park = parkList.row[i];
            var pat = /(서울특별시) ([가-힣]+)/g;
            if(pat.test(park.P_ADDR)){
                var matchName = RegExp.$2;
                if(matchName == areaName)
                    $('#parkList').append('<div onclick="JavascriptBridge.getParkProgramList(\''+park.P_IDX+'\');" id="'+park.P_IDX+'">'+park.P_PARK+' ( '+park.P_ADDR+' )</div>');
            }
        }
    }

    function setParkProgramList(data){
		console.log(data);
		$('#parkProgramList').html('');

    	var count = data["SearchProgramsByParkIDService"]["list_total_count"];
		var list = data["SearchProgramsByParkIDService"]["row"];
        for(var i = 0 ; i < list.length ; i ++){
        	var pData = list[i];
        	$('#parkProgramList').append("<div onclick='panTo(\""+pData['LATITUDE']+"\",\""+pData['LONGITUDE']+"\",\""+pData['P_PARK']+"\")'>" + pData['P_PARK'] + "( "+pData['P_NAME']+" )" + "</div>");
        }
    }
    
    function panTo(lat, lng, name) {
    	$(window).scrollTop(0);
    	var markerPosition  = new daum.maps.LatLng(lat, lng); 
    	// 마커를 생성합니다
    	var marker = new daum.maps.Marker({
    	    position: markerPosition
    	});
    	// 마커가 지도 위에 표시되도록 설정합니다
    	marker.setMap(map);
    	
    	var iwContent = '<div style="padding:5px;">'+name+' <br><a href="http://map.daum.net/link/map/'+name+','+lat+','+lng+'" style="color:blue" target="_blank">큰지도보기</a> <a href="http://map.daum.net/link/to/'+name+','+lat+','+lng+'" style="color:blue" target="_blank">길찾기</a></div>', // 인포윈도우에 표출될 내용으로 HTML 문자열이나 document element가 가능합니다
        iwPosition = new daum.maps.LatLng(lat, lng); //인포윈도우 표시 위치입니다

	    // 인포윈도우를 생성합니다
	    var infowindow = new daum.maps.InfoWindow({
	        position : iwPosition, 
	        content : iwContent 
	    });
	      
	    // 마커 위에 인포윈도우를 표시합니다. 두번째 파라미터인 marker를 넣어주지 않으면 지도 위에 표시됩니다
	    infowindow.open(map, marker); 
    	
        // 이동할 위도 경도 위치를 생성합니다 
        var moveLatLon = new daum.maps.LatLng(lat, lng);
        // 지도 중심을 부드럽게 이동시킵니다
        // 만약 이동할 거리가 지도 화면보다 크면 부드러운 효과 없이 이동합니다
        map.panTo(moveLatLon);            
        JavascriptBridge.getWeather(lat, lng);
    }
    
    function setWeather(data){
    	/*
    	- Base_time  : 0200, 0500, 0800, 1100, 1400, 1700, 2000, 2300 (1일 8회)
		- API 제공 시간(~이후) : 02:30, 05:30, 08:30, 11:30, 14:30, 20:30, 23:30

    	T1H	기온	 ℃	-50 ℃	10
	RN1	1시간 강수량	mm	-1 mm	8
	SKY	하늘상태	코드값	-1	4
	UUU	동서바람성분	m/s	-100 m/s	12
	VVV	남북바람성분	m/s	-100 m/s	12
	REH	습도	%	-1 %	8
	PTY	강수형태	코드값	-1	4
	LGT	낙뢰	코드값	-1	4
	VEC	풍향	0	-1	10
	WSD	풍속	1	-1	10
    	*/
    	
    	/*
    	하늘상태	전운량
		맑음	0 ～ 2
		구름조금	3 ～ 5
		구름많음	6 ～ 8
		흐림	9 ～ 10
    	*/
    	var xml = $.parseXML(data);
    	$(xml).find('item').each(function(index, node){
    		if($(node).find('category').text() == 'SKY'){
    			var skyVal = parseInt($(node).find('obsrValue').text());
    			if( skyVal < 3 ){
    				$('#'+ $(node).find('category').text() +' span').text("맑음");
    			}else if( skyVal < 6 ){
    				$('#'+ $(node).find('category').text() +' span').text("구름 조금");
    			}else if( skyVal < 9 ){
    				$('#'+ $(node).find('category').text() +' span').text("구름 많음");
    			}else{
    				$('#'+ $(node).find('category').text() +' span').text("흐림");
    			}
    		}else{
    			$('#'+ $(node).find('category').text() +' span').text($(node).find('obsrValue').text());
    		}
    	});
    }

   	</script>
</body>
</html>
