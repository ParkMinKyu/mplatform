<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="UTF-8">
    <title>Mplatform by ParkMinKyu</title>
	<meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, width=device-width">
</head>
<body>
<a href="#" id="kakaoBtn">
	<img src="https://github.com/ParkMinKyu/newLotto/blob/gh-pages/kakaolink_btn_small.png?raw=true"/>
</a>
<div id="main" style="margin: 80px auto;">
	<input type="hidden" id="pageIdx" value="0">
	<button id="backBtn" style="display:none;">뒤로가기</button>
	<div id="pageNo1" style="position: absolute;">
		<img src="/mplatform/images/main.jpeg"/><br>
		<button id="startBtn">시작</button>
	</div>
	<div id="pageNo2" style="visibility: hidden;position: absolute;">
		지역별 공원 현황
		<div id="areaList">

		</div>
	</div>
	<div id="pageNo3" style="visibility: hidden;position: absolute;">
		<div id="parkList">

		</div>
		<div id="weather">
			<div id="T1H">기온 : <span></span></div>
			<div id="RN1">1시간 강수량 : <span></span></div>
			<div id="SKY">하늘상태 : <span></span></div>
			<div id="UUU">동서바람성분 : <span></span></div>
			<div id="VVV">남북바람성분 : <span></span></div>
			<div id="REH">습도 : <span></span></div>
			<div id="PTY">강수형태 : <span></span></div>
			<div id="LGT">낙뢰 : <span></span></div>
			<div id="VEC">풍향 : <span></span></div>
			<div id="WSD">풍속 : <span></span></div>
		</div>
	</div>
	<div id="pageNo4" style="visibility: hidden;position: absolute;">
		<div id="map" style="width:100%;height:300px;"></div>
		<div id="parkProgramList">

		</div>
	</div>
</div>
<script src="/mplatform/js/jquery-1.11.3.min.js" type="text/javascript"></script>
<script type="text/javascript" src="//apis.daum.net/maps/maps3.js?apikey=5f101424c141ce53e3ed5e26f10ca225"></script>
<script>
	var mapContainer = document.getElementById('map'), // 지도를 표시할 div
	    mapOption = {
	        center: new daum.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
	        level: 5 // 지도의 확대 레벨
	    };

	// 지도를 표시할 div와  지도 옵션으로  지도를 생성합니다
	var map = new daum.maps.Map(mapContainer, mapOption);
	map.addOverlayMapTypeId(daum.maps.MapTypeId.TRAFFIC);

	var parkList = {};
    var parkProgramList = {};

	$(function(){
        $('#startBtn').click(function(){
            if(parkList.row == null || parkProgramList.row == null)
                JavascriptBridge.getParkList();
            else
                displayArea();
        });

        $('#kakaoBtn').click(function(){
			JavascriptBridge.sendMessage("test");
		});

        $('#backBtn').click(function(){
            var pageNo = parseInt($('#pageIdx').val());
            pageMove(pageNo - 1);
        });
    });

    function compare(a,b) {
      var pat = /(서울특별시) ([가-힣]+)/g;
      var pat2 = /(서울특별시) ([가-힣]+)/g;
      var addr1;
      var addr2;
      if(pat.test(a.P_ADDR)){
            addr1 = RegExp.$2;
      }
      if(pat2.test(b.P_ADDR)){
            addr2 = RegExp.$2;
      }
      if (addr1 < addr2)
        return -1;
      if (addr1 > addr2)
        return 1;
      return 0;
    }

    function pageMove(pageNo){
        if(parseInt(pageNo) > 2){
            $('#backBtn').show();
        }else{
            $('#backBtn').hide();
        }

        $('#main div').css('visibility','hidden');
        $('#pageNo'+pageNo).css('visibility','visible');
        $('#pageNo'+pageNo+' div').css('visibility','visible');
        $('#pageIdx').val(pageNo);
    }

    function setParkList(data){
		parkList.totalCount = data["SearchParkInfoService"]["list_total_count"];
        parkList.row = data["SearchParkInfoService"]["row"];
        parkList.row.sort(compare);
        displayArea();
    }

    function setParkProgramList(data){
        parkProgramList.totalCount = data["SearchProgramsByParkIDService"]["list_total_count"];
        parkProgramList.row = data["SearchProgramsByParkIDService"]["row"];
    }

    function getProgramCount(parkId){
    	if(parkProgramList.row == null)
    		return 0;

        var list = parkProgramList.row;
        var count = 0;
        for(var i = 0 ; i < list.length ; i ++){
        	var pData = list[i];
        	if(pData.P_IDX == parkId)
        	    count++;
        }
        return count;
    }

    function displayArea(){
		$('#areaList').html('');
        for(var i = 0 ; i < parkList.row.length ; i ++){
            var park = parkList.row[i];
            var pat = /(서울특별시) ([가-힣]+)/g;
            if(pat.test(park.P_ADDR)){
                var areaName = RegExp.$2;
                if( $('#'+areaName).length > 0 ){
                    var count = parseInt($('#' + areaName + ' #count').text())+1;
                    $('#' + areaName + ' #count').text(count);
                }
                else{
                    $('#areaList').append('<div onclick="displayParkList(\''+areaName+'\');" id="'+areaName+'">'+areaName+' ( 공원 <span id="count">'+1+'</span>개 )</div>');
                 }
            }
        }
        pageMove(2);
        JavascriptBridge.getParkProgramList('');
    }

    function displayParkList(areaName){
		$('#parkList').html('');
        for(var i = 0 ; i < parkList.row.length ; i ++){
            var park = parkList.row[i];
            var pat = /(서울특별시) ([가-힣]+)/g;
            if(pat.test(park.P_ADDR)){
                var matchName = RegExp.$2;
                if(matchName == areaName){
                    $('#parkList').append('<div onclick="displayParkProgramList(\''+park.P_IDX+'\');" id="'+park.P_IDX+'">'+park.P_PARK+' ( 프로그램 '+getProgramCount(park.P_IDX)+'개 )</div>');
				}
            }
            if( i == (parkList.row.length -1) ){
             	JavascriptBridge.getWeather(park.LATITUDE, park.LONGITUDE);
            }
        }

        pageMove(3);
    }

    function displayParkProgramList(parkId){
		$('#parkProgramList').html('');
		var list = parkProgramList.row;
		var mapData = {};
        for(var i = 0 ; i < list.length ; i ++){
        	var pData = list[i];
        	if(pData.P_IDX == parkId){
        		mapData = pData;
        	    $('#parkProgramList').append("<div>" + pData['P_PARK'] + "( "+pData['P_NAME']+" )" + "</div>");
			}
        }
        pageMove(4);
		panTo(mapData['LATITUDE'],mapData['LONGITUDE'],mapData['P_PARK']);
    }

    function setWeather(data){
    	var xml = $.parseXML(data);
    	$(xml).find('item').each(function(index, node){
    		if($(node).find('category').text() == 'SKY'){
    			var skyVal = parseInt($(node).find('obsrValue').text());
    			if( skyVal < 3 ){
    				$('#'+ $(node).find('category').text() +' span').text("맑음");
    			}else if( skyVal < 6 ){
    				$('#'+ $(node).find('category').text() +' span').text("구름 조금");
    			}else if( skyVal < 9 ){
    				$('#'+ $(node).find('category').text() +' span').text("구름 많음");
    			}else{
    				$('#'+ $(node).find('category').text() +' span').text("흐림");
    			}
    		}else{
    			$('#'+ $(node).find('category').text() +' span').text($(node).find('obsrValue').text());
    		}
    	});
    }
</script>
</body>
</html>
